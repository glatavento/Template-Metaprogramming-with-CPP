\documentclass[11pt, onecolumn, oneside]{ctexbook}

\usepackage{xpatch,mathtools}
\usepackage[a5paper, scale=0.8]{geometry}
\usepackage{subfiles,graphicx,enumitem,titlesec,pdfpages}
% \usepackage{tabularx,booktabs,multirow}
\usepackage{tabularray}
\usepackage[most]{tcolorbox}
\usepackage[pdfusetitle]{hyperref}
\usepackage{bookmark,xurl}
\usepackage{minted}

\title{Template Metaprogramming with C++ \large \\ Learn everything about C++ templates and unlock the power of template metaprogramming \\ 详细的了解C++模板，释放模板元编程的力量}
\author{作者：Marius Bancila  \and 译者：陈晓伟}
\date{\today}

\ExplSyntaxOn

% Remove newpage after \part
\assignpagestyle { \part } { empty }
\titleclass   { \part } { top }
\titleformat  { \part } [ display ]              % shape
                        { \Huge\bfseries }       % format
                        { 第 \zhdig{part} 部分 }  % label
                        { 0.5em }                % sep
                        {}                       % before-code
                        []                       % after-code
\titlespacing { \part } { 0pt }  % left
                        { 0pt }  % before-sep
                        { 2em }  % after-sep
                      % []       % right-sep
\xpatchcmd { \@endpart } { \vfil\newpage } {} {} {}
\xpatchcmd { \@endpart } { \newpage      } {} {} {}

% Setup fonts
\setmainfont { Libertinus~Serif }
\setsansfont { Libertinus~Sans  }
\setmonofont { Iosevka~Slab     }

% Setup hyperlinks
\hypersetup { breaklinks=true }

% Setup enumerate, itemize and description
\setlist { nosep }
\setitemize{ labelsep=0pt,
             label=\makebox[1em]{\textbullet},
             leftmargin=3em,
             itemindent=0em,
             labelwidth=1em }
\SetEnumitemKey { tableitem } { leftmargin=0cm }

% Setup tblr
\UseTblrLibrary { varwidth }
\SetTblrInner [ talltblr, longtblr ] { hlines, rows={m}, row{1} = {c, font=\bfseries} }
\SetTblrInner [ longtblr ] { rowhead=1, measure=vbox }
\DefTblrTemplate { contfoot-text } { normal } { 续下页  }
\DefTblrTemplate { conthead-text } { normal } { （接前页） }
\SetTblrTemplate { contfoot-text } { normal }
\SetTblrTemplate { conthead-text } { normal }
\SetTblrTemplate { caption-sep   } { empty  } % Remove : after table number

% Setup minted
\setminted { obeytabs, tabsize=2, breaklines=true, fontsize=\footnotesize, frame=single }
\setmintedinline { breaklines=true, fontsize=\normalsize }

% Def \inlcpp
\NewDocumentCommand { \inlcpp }   { m }
{ \mintinline { cpp } { #1 } }

% Def cpp environment
\NewDocumentEnvironment { cpp } { }
{ \VerbatimEnvironment
  \begin { minted } [ linenos=true ] { cpp } }
{ \end   { minted } }

% Def shell environment
\NewDocumentEnvironment { shell } { }
{ \VerbatimEnvironment
  \begin { minted } { text } }
{ \end   { minted } }

\NewDocumentEnvironment { note } { }
{ \begin { tcolorbox } [breakable,enhanced~jigsaw,colback=blue!5!white,colframe=blue!75!black,title={Note}] }
{ \end   { tcolorbox } }

\NewDocumentEnvironment { important } { }
{ \begin { tcolorbox } [breakable,enhanced~jigsaw,colback=blue!5!white,colframe=blue!75!black,title={重要的Note}] }
{ \end   { tcolorbox } }

\ExplSyntaxOff

\begin{document}

\includepdf{cover.pdf}
\maketitle

% 前言部分
\frontmatter
\setcounter{secnumdepth}{0}

\subfile{frontmatter/Description.tex}
\subfile{frontmatter/Credits.tex}
\subfile{frontmatter/Preface.tex}

% 目录
\newpage
\phantomsection
\addcontentsline{toc}{chapter}{目录}
\tableofcontents

% % 正文部分
\mainmatter
\setcounter{secnumdepth}{2}

\subfile{content/part1.tex}
\subfile{content/part2.tex}
\subfile{content/part3.tex}

% 后记部分
\backmatter
\bookmarksetup{startatroot}
\setcounter{secnumdepth}{0}
\subfile{backmatter/Closing-Notes.tex}
\subfile{backmatter/Assignment-Answers.tex}

\end{document}

